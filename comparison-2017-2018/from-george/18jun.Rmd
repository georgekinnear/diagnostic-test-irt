---
title: "ETH Zurich June 2019"
author: "George Kinnear"
date: "18 June 2019"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ggplot2)
library(ggrepel)
library(ggpubr)
library(mirt)
library(reshape)
library(RColorBrewer)
library(tidyverse)

pal36 = c(brewer.pal(8, "Purples")[3:8],
          brewer.pal(8, "Greens")[3:8],
          brewer.pal(8, "Oranges")[3:8],
          brewer.pal(8, "Blues")[3:8],
          brewer.pal(8, "Reds")[3:8],
          brewer.pal(8, "Greys")[3:8])

source('f_IRT.R') # the attached R file


# Comparing cohorts
eth_2018 = read.csv('data/2018/all.csv')
eth_2017 = read.csv('data/2017/all.csv')

eth_both_years = bind_rows(list("2018" = eth_2018,
                                "2017" = eth_2017),
                           .id = "year")

fit_2pl <- mirt(eth_both_years[2:37], 1, itemtype="2PL", SE=T)
eap_2pl <- data.frame(fscores(fit_2pl, method='EAP'))
eth_both_years$F1 = eap_2pl$F1
coefs = coef(fit_2pl, IRTpars = TRUE)

library(purrr)

# Manipulate the coefs data into a tidier form
#
# coefs is a list of tables. We map a function onto each of those tables, which
# turns it into a table of just the a and b parameters (their values and CIs),
# then we turn that into a tibble and unnest the list (i.e. turn it into one big table)
pars = map(coefs, function(x) melt(x) %>%
             filter(X2 %in% c("a", "b")) %>%
             mutate(X1 = if_else(X1=="par", "value", paste0(X1)),
                    value = round(value, 3)) %>%
             unite(X2, X1, col="Var", sep="_") %>%
             spread(Var, value)) %>%
  tibble(coefficients = .) %>%
  unnest(cols = coefficients) %>%
  mutate(Question = paste0("A",c(1:36))) # this is a hack - not sure how to keep the list keys as a column!
```


## 2PL results

This shows the results of fitting the 2PL model using the `mirt` package.

* \(a\) is discrimination
* \(b\) is difficulty
* endpoints of the 95% confidence intervals are also shown

```{r}
pars
```

```{r, echo=FALSE}
renderDataTable(pars, options = list(lengthMenu = c(5, 10, 36), pageLength = 10))
```


## Item Fit

Comparison of the IRT curve and the observed proportions.

```{r itemfit, echo=FALSE}
inputPanel(

  sliderInput("item_choice", label = "Item:",
              min = 1, max = 36, value = 1, step = 1)
)

renderPlot({
  itemfit(fit_2pl,
        group.bins = 15,
        empirical.plot = input$item_choice)
})
```

## Comparing 2017 and 2018

```{r cohort_comparison, echo=FALSE}
ggplot(eth_both_years, aes(F1, fill=as.factor(year), colour=as.factor(year))) +
  geom_density(alpha=0.5) + 
  scale_x_continuous(limits=c(-3.5,3.5)) +
  labs(title="Density plot", 
       subtitle="Ability grouped by year of taking the test", 
       x="Ability", 
       fill='Year', colour='Year')
```


## Factor analysis

```{r}
library(psych)
fa.parallel(eth_both_years[2:37], fa='fa')

```

### 1 Factor
```{r}
fitfact <- factanal(eth_both_years[2:37], 1, rotation="varimax")
print(fitfact, digits=2, cutoff=.3, sort=TRUE)
load <- data.frame(fitfact$loadings[,])
names(load) = c("Factor1")
ggplot(load, aes(x=Factor1, y=0)) + 
  geom_point() + 
  geom_label_repel(aes(label = rownames(load)), show.legend=F) +
  labs(x='Factor 1', 
       y='', 
       title='Standardised Loadings', 
       subtitle='Based upon correlation matrix')
```

### 2 Factors
```{r}
fitfact <- factanal(eth_both_years[2:37], 2, rotation="varimax")
print(fitfact, digits=2, cutoff=.3, sort=TRUE)
load <- data.frame(fitfact$loadings[,])
ggplot(load, aes(x=Factor1, y=Factor2)) + 
  geom_point() + 
  geom_label_repel(aes(label = rownames(load)), show.legend=F) +
  labs(x='Factor 1', 
       y='Factor 2', 
       title='Standardised Loadings', 
       subtitle='Based upon correlation matrix')
```

### 9 Factors (showing only first 2)
```{r}
fitfact <- factanal(eth_both_years[2:37], 9, rotation="varimax")
print(fitfact, digits=2, cutoff=.3, sort=TRUE)
load <- data.frame(fitfact$loadings[,])
ggplot(load, aes(x=Factor1, y=Factor2)) + 
  geom_point() + 
  geom_label_repel(aes(label = rownames(load)), show.legend=F) +
  labs(x='Factor 1', 
       y='Factor 2', 
       title='Standardised Loadings', 
       subtitle='Based upon correlation matrix')
```


## Investigating differences between groups

Do students from different programmes of study have different distributions of ability?

```{r, include=FALSE}
# produce list of all the relevant filenames
# (match only the courses beginning 401, i.e. exclude "all.csv")
files_2018 = paste0("2018/", dir("data/2018/", pattern = "401.*.csv"))
files_2017 = paste0("2017/", dir("data/2017/", pattern = "401.*.csv"))

files = c(files_2018, files_2017)

eth_entry_test <- data_frame(filename = files) %>%
  mutate(
    file_contents = map(filename,
           ~ read_csv(file.path("data/", .)))
  ) %>%
  separate(filename, c("year", "class"), sep = "/") %>%
  mutate(class = str_remove(class, ".csv")) %>%
  unnest()

fit_2pl <- mirt(eth_entry_test[3:38], 1, itemtype="2PL", SE=T)
eap_2pl <- data.frame(fscores(fit_2pl, method='EAP'))
eth_entry_test$F1 = eap_2pl$F1

# TODO - fix this function so that it works with 2PL input
#myggplot.mirt(fit_2pl, col = pal36)

```

### Differences between year groups

```{r}
# Compare the distribution of abilities in the two years
ggplot(eth_entry_test, aes(F1, fill=as.factor(year), colour=as.factor(year))) +
  geom_density(alpha=0.5) + 
  scale_x_continuous(limits=c(-3.5,3.5)) +
  labs(title="Density plot", 
       subtitle="Ability grouped by year of taking the test", 
       x="Ability", 
       fill='Year', colour='Year')
```

There does not seem to be a big difference between the two year groups, so we combine them in the following analysis.


### Differences between classes

```{r}
# Compare the distribution of abilities in the two years
ggplot(eth_entry_test, aes(F1, fill=as.factor(class), colour=as.factor(class))) +
  geom_density(alpha=0.5) + 
  scale_x_continuous(limits=c(-3.5,3.5)) +
  labs(title="Density plot", 
       subtitle="Ability grouped by class", 
       x="Ability", 
       fill='Class', colour='Class')
```

That plot is hard to read, so try another approach:

```{r}
library(ggridges)

# Compare the distribution of abilities in the two years
ggplot(eth_entry_test, aes(x = F1, y = class, colour = class, fill = class)) +
  geom_density_ridges(alpha=0.5) + 
  scale_x_continuous(limits=c(-3.5,3.5)) +
  labs(title="Density plot", 
       subtitle="Ability grouped by class", 
       x="Ability", 
       fill='Class', colour='Class')
```




